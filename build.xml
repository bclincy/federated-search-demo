<project name="federated-search-demo" default="build">
    <!-- Run with: vendor/bin/phing -Dbuild.env=vagrant -->
    <!-- For a list of commands, try: vendor/bin/phing -Dbuild.env=vagrant -l -->


    <import file="vendor/palantirnet/the-build/tasks/boilerplate.xml" />


    <!-- Make these commands available by default. -->
    <import file="vendor/palantirnet/the-build/tasks/drupal.xml" />
    <import file="vendor/palantirnet/the-build/tasks/acquia.xml" />


    <!-- Default target: build -->
    <target name="build" description="Build the application.">
        <phingcall target="drupal-build" />
    </target>


    <!-- Target: install -->
    <target name="install" description="Install the application.">
        <phingcall target="drupal-install" />

        <phingcall target="drupal-reinstall-module">
            <property name="module" value="demo_umami_content" />
        </phingcall>

        <drush command="pm-enable" assume="yes">
            <param>federated_terms</param>
        </drush>
        <drush command="pm-uninstall" assume="yes">
            <param>federated_terms</param>
        </drush>
        <drush command="sapi-c" assume="yes">
            <param>federated_search</param>
        </drush>
        <drush command="sapi-i" assume="yes">
            <param>federated_search</param>
        </drush>

        <!-- Import config to fix rogue blocks changing UUIDs -->
        <drush command="config-import" assume="yes"/>

    </target>

    <!-- Target: install -->
    <target name="install-d7" description="Install the D7 site.">
        <drush command="site-install" assume="yes" root="/var/www/federated-search-demo.local/web/d7/web">
            <option name="site-name">Federated SOLR D7</option>
            <option name="account-pass">admin</option>
            <param>standard</param>
        </drush>
        <drush command="pm-enable" assume="yes" root="/var/www/federated-search-demo.local/web/d7/web">
            <param>features_search_api_config</param>
        </drush>
        <drush command="pm-enable" assume="yes" root="/var/www/federated-search-demo.local/web/d7/web">
            <param>devel_generate</param>
        </drush>
        <drush command="pm-disable" assume="yes" root="/var/www/federated-search-demo.local/web/d7/web">
            <param>overlay</param>
            <param>toolbar</param>
        </drush>
        <drush command="generate-content" assume="yes" root="/var/www/federated-search-demo.local/web/d7/web">
            <param>10</param>
        </drush>
    </target>

    <!-- Target: init -->
    <target name="init" description="Initialize the repo for development.">
        <!-- Link search_api_federated_solr:master (D8) into the src/ directory so the code is easy to find. -->
        <mkdir dir="${build.dir}/src" />
        <delete file="${build.dir}/src/search_api_federated_solr" />
        <symlink target="../web/modules/contrib/search_api_federated_solr" link="src/search_api_federated_solr" />

        <!-- Link search_api_field_map:master (D8) into the src/ directory so the code is easy to find. -->
        <mkdir dir="${build.dir}/src" />
        <delete file="${build.dir}/src/search_api_field_map" />
        <symlink target="../web/modules/contrib/search_api_field_map" link="src/search_api_field_map" />

        <!-- Link search_api_federated_solr:7.x into the src/ directory so the code is easy to find. -->
        <mkdir dir="${build.dir}/src" />
        <delete file="${build.dir}/src/search_api_federated_solr-7.x" />
        <symlink target="../web/d7/web/sites/all/modules/contrib/search_api_federated_solr" link="src/search_api_federated_solr-7.x" />

        <!-- Link search_api_field_map:7.x into the src/ directory so the code is easy to find. -->
        <mkdir dir="${build.dir}/src" />
        <delete file="${build.dir}/src/search_api_field_map-7.x" />
        <symlink target="../web/d7/web/sites/all/modules/contrib/search_api_field_map" link="src/search_api_field_map-7.x" />

    </target>


    <!-- Target: migrate -->
    <target name="migrate" description="Run the migrations.">
        <echo>Configure this target to load sample data and run the migrations.</echo>
    </target>


    <!-- Target: test -->
    <target name="test" description="Run all the tests.">
        <echo>Configure this target to run the tests.</echo>
        <!-- You may want to include one or more of the commands from the 'code-review' target here. -->
    </target>


    <!-- Target: code-review -->
    <target name="code-review" description="Run the automated code reviews.">
        <!-- These are called directly rather than using <import> because they are single-purpose task files. -->
        <phing phingfile="${build.dir}/vendor/palantirnet/the-build/tasks/code_review/drupal_code_sniffer.xml" />
        <phing phingfile="${build.dir}/vendor/palantirnet/the-build/tasks/code_review/phpmd.xml" />
        <phing phingfile="${build.dir}/vendor/palantirnet/the-build/tasks/code_review/phplint.xml" />
    </target>


    <!-- Target: deploy -->
    <target name="deploy" description="Build and deploy the application.">
        <echo>Configure this target to build the production artifact; see the `deploy-to-acquia` target for an example.</echo>
    </target>


    <!-- Target: deploy-to-acquia -->
    <target name="deploy-to-acquia">
        <phingcall target="check-deploy-env" />
        <phingcall target="acquia-build" />
        <phingcall target="build" />
        <phingcall target="acquia-deploy" />
    </target>


</project>
